<!doctype html><html class="" data-reactroot=""><head><link rel="icon" type="image/png" href="/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="我的图书馆"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">代码重构经验 · ViktorHub</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><header><h1 class="hide_on_mobile"><a href="/">ViktorHub</a></h1><nav><ul><li class="show_on_mobile flex_center"><a class="czs-menu-l" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a></li><li class="show_on_mobile"><h1 class="mobile_title"><a href="/">ViktorHub</a></h1></li><li class="hide_on_mobile"><a href="/collection/index.html">秘籍收藏</a></li><li class="hide_on_mobile"><a href="/interview/index.html">面霸心经</a></li><li class="hide_on_mobile"><a href="/start/index.html">修仙入门</a></li><li class="hide_on_mobile"><a href="/advanced/index.html">进阶功法</a></li><li class="hide_on_mobile"><a href="/crossover/RN.html">跨界码王</a></li><li style="flex-grow:1"></li><li class="flex_center"><a class="czs-github-logo" href="https://github.com/ViktorWong/my-docs" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul></nav></header><aside class="sidebar"><ol class="list_style_none"><li class=""><a href="/start/CSS.html" class="nav_link">CSS 入门</a></li><li class=""><a href="/start/CSS3.html" class="nav_link">CSS3新特性</a></li><li class=""><a href="/start/JS.html" class="nav_link">深入 JavaScript</a></li><li class=""><a href="/start/Mobile.html" class="nav_link">移动端常见问题</a></li><li class=""><a href="/start/Performance.html" class="nav_link">性能优化</a></li><li class=""><a href="/start/Codeing.html" class="nav_link active">代码重构经验</a></li><li class=""><a href="/start/Mobx.html" class="nav_link">Mobx</a></li></ol></aside><section class="main"><div class="main_article"><article><h1 id="%E4%BB%A3%E7%A0%81%E9%87%8D%E6%9E%84%E7%BB%8F%E9%AA%8C">代码重构经验<a class="anchor" href="#%E4%BB%A3%E7%A0%81%E9%87%8D%E6%9E%84%E7%BB%8F%E9%AA%8C">§</a></h1>
<h2 id="%E6%8F%90%E7%82%BC%E5%87%BD%E6%95%B0">提炼函数<a class="anchor" href="#%E6%8F%90%E7%82%BC%E5%87%BD%E6%95%B0">§</a></h2>
<p>在 JavaScript 开发中，我们大部分时间都在与函数打交道，所以我们希望这些函数有着良好的命名，函数体内包含的逻辑清晰明了。如果一个函数过长，不得不加上若干注释才能让这个函数显得易读一些，那这些函数就很有必要进行重构。
如果在函数中有一段代码可以被独立出来，那我们最好把这些代码放进另外一个独立的函数中。这是一种很常见的优化工作，这样做的好处主要有以下几点。</p>
<ul>
<li>避免出现超大函数。</li>
<li>独立出来的函数有助于代码复用。</li>
<li>独立出来的函数更容易被覆写。</li>
<li>独立出来的函数如果拥有一个良好的命名，它本身就起到了注释的作用。
比如在一个负责取得用户信息的函数里面，我们还需要打印跟用户信息有关的 log，那么打印 log 的语句就可以被封装在一个独立的函数里：</li>
</ul>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">getUserInfo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">"http:// xxx.com/userInfo"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"userId: "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token property-access">userId</span><span class="token punctuation">)</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"userName: "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token property-access">userName</span><span class="token punctuation">)</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"nickName: "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token property-access">nickName</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>改成：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">getUserInfo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">"http:// xxx.com/userInfo"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printDetails</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">printDetails</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"userId: "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token property-access">userId</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"userName: "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token property-access">userName</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"nickName: "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token property-access">nickName</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="%E5%90%88%E5%B9%B6%E9%87%8D%E5%A4%8D%E7%9A%84%E6%9D%A1%E4%BB%B6%E7%89%87%E6%AE%B5">合并重复的条件片段<a class="anchor" href="#%E5%90%88%E5%B9%B6%E9%87%8D%E5%A4%8D%E7%9A%84%E6%9D%A1%E4%BB%B6%E7%89%87%E6%AE%B5">§</a></h2>
<p>如果一个函数体内有一些条件分支语句，而这些条件分支语句内部散布了一些重复的代码， 那么就有必要进行合并去重工作。假如我们有一个分页函数 <code>paging</code>，该函数接收一个参数<code>currPage</code>，<code>currPage</code> 表示即将跳转的页码。在跳转之前，为防止 <code>currPage</code> 传入过小或者过大的数字，我们要手动对它的值进行修正，详见如下伪代码：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">paging</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">currPage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>currPage <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currPage <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token function">jump</span><span class="token punctuation">(</span>currPage<span class="token punctuation">)</span> <span class="token comment">// 跳 转</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>currPage <span class="token operator">>=</span> totalPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currPage <span class="token operator">=</span> totalPage
    <span class="token function">jump</span><span class="token punctuation">(</span>currPage<span class="token punctuation">)</span> <span class="token comment">// 跳 转</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token function">jump</span><span class="token punctuation">(</span>currPage<span class="token punctuation">)</span> <span class="token comment">// 跳 转</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到，负责跳转的代码 <code>jump( currPage )</code>在每个条件分支内都出现了，所以完全可以把这句代码独立出来：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">paging</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">currPage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>currPage <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currPage <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>currPage <span class="token operator">>=</span> totalPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currPage <span class="token operator">=</span> totalPage
  <span class="token punctuation">}</span>
  <span class="token function">jump</span><span class="token punctuation">(</span>currPage<span class="token punctuation">)</span> <span class="token comment">// 把 jump 函数独立出来</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="%E6%8A%8A%E6%9D%A1%E4%BB%B6%E5%88%86%E6%94%AF%E8%AF%AD%E5%8F%A5%E6%8F%90%E7%82%BC%E6%88%90%E5%87%BD%E6%95%B0">把条件分支语句提炼成函数<a class="anchor" href="#%E6%8A%8A%E6%9D%A1%E4%BB%B6%E5%88%86%E6%94%AF%E8%AF%AD%E5%8F%A5%E6%8F%90%E7%82%BC%E6%88%90%E5%87%BD%E6%95%B0">§</a></h2>
<p>在程序设计中，复杂的条件分支语句是导致程序难以阅读和理解的重要原因，而且容易导致一个庞大的函数。假设现在有一个需求是编写一个计算商品价格的 getPrice 函数，商品的计算只有一个规则：如果当前正处于夏季，那么全部商品将以 8 折出售。代码如下：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">getPrice</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">price</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>date<span class="token punctuation">.</span><span class="token method function property-access">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">6</span> <span class="token operator">&amp;&amp;</span> date<span class="token punctuation">.</span><span class="token method function property-access">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 夏 天</span>
    <span class="token keyword control-flow">return</span> price <span class="token operator">*</span> <span class="token number">0.8</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> price<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

观察这句代码：
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>date<span class="token punctuation">.</span><span class="token method function property-access">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">6</span> <span class="token operator">&amp;&amp;</span> date<span class="token punctuation">.</span><span class="token method function property-access">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这句代码要表达的意思很简单，就是判断当前是否正处于夏天（7~10 月）。尽管这句代码很短小，但代码表达的意图和代码自身还存在一些距离，阅读代码的人必须要多花一些精力才能明白它传达的意图。其实可以把这句代码提炼成一个单独的函数，既能更准确地表达代码的意思， 函数名本身又能起到注释的作用。代码如下：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">isSummer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> date<span class="token punctuation">.</span><span class="token method function property-access">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">6</span> <span class="token operator">&amp;&amp;</span> date<span class="token punctuation">.</span><span class="token method function property-access">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">9</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">getPrice</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">price</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isSummer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 夏 天</span>
    <span class="token keyword control-flow">return</span> price <span class="token operator">*</span> <span class="token number">0.8</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> price
<span class="token punctuation">}</span>
</code></pre>
<h2 id="%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E5%BE%AA%E7%8E%AF">合理使用循环<a class="anchor" href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E5%BE%AA%E7%8E%AF">§</a></h2>
<p>在函数体内，如果有些代码实际上负责的是一些重复性的工作，那么合理利用循环不仅可以完成同样的功能，还可以使代码量更少。下面有一段创建 XHR 对象的代码，为了简化示例，我们只考虑版本 9 以下的 IE 浏览器，代码如下：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">createXHR</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> xhr
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"MSXML2.XMLHttp.6.0"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"MSXML2.XMLHttp.3.0"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">"MSXML2.XMLHttp"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> xhr
<span class="token punctuation">}</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>下面我们灵活地运用循环，可以得到跟上面代码一样的效果：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">createXHR</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> versions <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"MSXML2.XMLHttp.6.0ddd"</span><span class="token punctuation">,</span>
    <span class="token string">"MSXML2.XMLHttp.3.0"</span><span class="token punctuation">,</span>
    <span class="token string">"MSXML2.XMLHttp"</span>
  <span class="token punctuation">]</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> version<span class="token punctuation">;</span> <span class="token punctuation">(</span>version <span class="token operator">=</span> versions<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="%E6%8F%90%E5%89%8D%E8%AE%A9%E5%87%BD%E6%95%B0%E9%80%80%E5%87%BA%E4%BB%A3%E6%9B%BF%E5%B5%8C%E5%A5%97%E6%9D%A1">提前让函数退出代替嵌套条<a class="anchor" href="#%E6%8F%90%E5%89%8D%E8%AE%A9%E5%87%BD%E6%95%B0%E9%80%80%E5%87%BA%E4%BB%A3%E6%9B%BF%E5%B5%8C%E5%A5%97%E6%9D%A1">§</a></h2>
<p>许多程序员都有这样一种观念：“每个函数只能有一个入口和一个出口。”现代编程语言都会限制函数只有一个入口。但关于“函数只有一个出口”，往往会有一些不同的看法。
下面这段伪代码是遵守“函数只有一个出口的”的典型代码：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">del</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> ret
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">.</span><span class="token property-access">isReadOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不为只读的才能被删除</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token property-access">isFolder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是文件夹</span>
      ret <span class="token operator">=</span> <span class="token function">deleteFolder</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token property-access">isFile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是文件</span>
      ret <span class="token operator">=</span> <span class="token function">deleteFile</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> ret
<span class="token punctuation">}</span>
</code></pre>
<p>嵌套的条件分支语句绝对是代码维护者的噩梦，对于阅读代码的人来说，嵌套的 if、else 语句相比平铺的 if、else，在阅读和理解上更加困难，有时候一个外层 if 分支的左括号和右括号之间相隔 500 米之远。用《重构》里的话说，嵌套的条件分支往往是由一些深信“每个函数只能有一个出口的”程序员写出的。但实际上，如果对函数的剩余部分不感兴趣，那就应该立即退出。引导阅读者去看一些没有用的 else 片段，只会妨碍他们对程序的理解。
于是我们可以挑选一些条件分支，在进入这些条件分支之后，就立即让这个函数退出。要做到这一点，有一个常见的技巧，即在面对一个嵌套的 if 分支时，我们可以把外层 if 表达式进行反转。重构后的 del 函数如下：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">del</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token property-access">isReadOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 反转 if 表达式</span>
    <span class="token keyword control-flow">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token property-access">isFolder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">deleteFolder</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token property-access">isFile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">deleteFile</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="%E4%BC%A0%E9%80%92%E5%AF%B9%E8%B1%A1%E5%8F%82%E6%95%B0%E4%BB%A3%E6%9B%BF%E8%BF%87%E9%95%BF%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8">传递对象参数代替过长的参数列表<a class="anchor" href="#%E4%BC%A0%E9%80%92%E5%AF%B9%E8%B1%A1%E5%8F%82%E6%95%B0%E4%BB%A3%E6%9B%BF%E8%BF%87%E9%95%BF%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8">§</a></h2>
<p>有时候一个函数有可能接收多个参数，而参数的数量越多，函数就越难理解和使用。使用该函数的人首先得搞明白全部参数的含义，在使用的时候，还要小心翼翼，以免少传了某个参数或者把两个参数搞反了位置。如果我们想在第 3 个参数和第 4 个参数之中增加一个新的参数，就会涉及许多代码的修改，代码如下：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">setUserInfo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> address<span class="token punctuation">,</span> sex<span class="token punctuation">,</span> mobile<span class="token punctuation">,</span> qq</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"id= "</span> <span class="token operator">+</span> id<span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"name= "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"address= "</span> <span class="token operator">+</span> address<span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"sex= "</span> <span class="token operator">+</span> sex<span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"mobile= "</span> <span class="token operator">+</span> mobile<span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"qq= "</span> <span class="token operator">+</span> qq<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">setUserInfo</span><span class="token punctuation">(</span><span class="token number">1314</span><span class="token punctuation">,</span> <span class="token string">"sven"</span><span class="token punctuation">,</span> <span class="token string">"shenzhen"</span><span class="token punctuation">,</span> <span class="token string">"male"</span><span class="token punctuation">,</span> <span class="token string">"137********"</span><span class="token punctuation">,</span> <span class="token number">377876679</span><span class="token punctuation">)</span>
</code></pre>
<p>这时我们可以把参数都放入一个对象内，然后把该对象传入 setUserInfo 函数，setUserInfo 函数需要的数据可以自行从该对象里获取。现在不用再关心参数的数量和顺序，只要保证参数对应的 key 值不变就可以了：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">setUserInfo</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"id= "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"name= "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"address= "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token property-access">address</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"sex= "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token property-access">sex</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"mobile= "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token property-access">mobile</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"qq= "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token property-access">qq</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">setUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token number">1314</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"sven"</span><span class="token punctuation">,</span>
  address<span class="token operator">:</span> <span class="token string">"shenzhen"</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> <span class="token string">"male"</span><span class="token punctuation">,</span>
  mobile<span class="token operator">:</span> <span class="token string">"137********"</span><span class="token punctuation">,</span>
  qq<span class="token operator">:</span> <span class="token number">377876679</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="%E5%B0%BD%E9%87%8F%E5%87%8F%E5%B0%91%E5%8F%82%E6%95%B0%E6%95%B0%E9%87%8F">尽量减少参数数量<a class="anchor" href="#%E5%B0%BD%E9%87%8F%E5%87%8F%E5%B0%91%E5%8F%82%E6%95%B0%E6%95%B0%E9%87%8F">§</a></h2>
<p>如果调用一个函数时需要传入多个参数，那这个函数是让人望而生畏的，我们必须搞清楚这些参数代表的含义，必须小心翼翼地把它们按照顺序传入该函数。而如果一个函数不需要传入任何参数就可以使用，这种函数是深受人们喜爱的。在实际开发中，向函数传递参数不可避免，但我们应该尽量减少函数接收的参数数量。下面举个非常简单的示例。 有一个画图函数 draw，它现在只能绘制正方形，接收了 3 个参数，分别是图形的 width、heigth 以及 square：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">draw</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> square</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<p>但实际上正方形的面积是可以通过 width 和 height 计算出来的，于是我们可以把参数 square
从 draw 函数中去掉：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">draw</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">width<span class="token punctuation">,</span> height</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> square <span class="token operator">=</span> width <span class="token operator">*</span> height
<span class="token punctuation">}</span>
</code></pre>
<p>假设以后这个 draw 函数开始支持绘制圆形，我们需要把参数 width 和 height 换成半径 radius， 但图形的面积 square 始终不应该由客户传入，而是应该在 draw 函数内部，由传入的参数加上一定的规则计算得来。此时，我们可以使用策略模式，让 draw 函数成为一个支持绘制多种图形的函数。</p>
<h2 id="%E5%B0%91%E7%94%A8%E4%B8%89%E7%9B%AE%E8%BF%90%E7%AE%97%E7%AC%A6">少用三目运算符<a class="anchor" href="#%E5%B0%91%E7%94%A8%E4%B8%89%E7%9B%AE%E8%BF%90%E7%AE%97%E7%AC%A6">§</a></h2>
<p>有一些程序员喜欢大规模地使用三目运算符，来代替传统的 if、else。理由是三目运算符性能高，代码量少。不过，这两个理由其实都很难站得住脚。
即使我们假设三目运算符的效率真的比 if、else 高，这点差距也是完全可以忽略不计的。在实际的开发中，即使把一段代码循环一百万次，使用三目运算符和使用 if、else 的时间开销处在同一个级别里。
同样，相比损失的代码可读性和可维护性，三目运算符节省的代码量也可以忽略不计。让 JS 文件加载更快的办法有很多种，如压缩、缓存、使用 CDN 和分域名等。把注意力只放在使用三目运算符节省的字符数量上，无异于一个 300 斤重的人把超重的原因归罪于头皮屑。
如果条件分支逻辑简单且清晰，这无碍我们使用三目运算符：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> global <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token dom variable">window</span> <span class="token operator">!==</span> <span class="token string">"undefined"</span> <span class="token operator">?</span> <span class="token dom variable">window</span> <span class="token operator">:</span> <span class="token keyword">this</span>
</code></pre>
<p>但如果条件分支逻辑非常复杂，如下段代码所示，那我们最好的选择还是按部就班地编写
if、else。if、else 语句的好处很多，一是阅读相对容易，二是修改的时候比修改三目运算符周围的代码更加方便：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aup <span class="token operator">||</span> <span class="token operator">!</span>bup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> a <span class="token operator">===</span> doc
    <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token operator">:</span> b <span class="token operator">===</span> doc
      <span class="token operator">?</span> <span class="token number">1</span>
      <span class="token operator">:</span> aup
        <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token operator">:</span> bup
          <span class="token operator">?</span> <span class="token number">1</span>
          <span class="token operator">:</span> sortInput
            <span class="token operator">?</span> indexOf<span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>sortInput<span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token operator">-</span> indexOf<span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>sortInput<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8">合理使用链式调用<a class="anchor" href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8">§</a></h2>
<p>经常使用 jQuery 的程序员相当习惯链式调用方法，在 JavaScript 中，可以很容易地实现方法的链式调用，即让方法调用结束后返回对象自身，如下代码所示：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function"><span class="token maybe-class-name">User</span></span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">=</span> <span class="token keyword null nil">null</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> <span class="token keyword null nil">null</span>
<span class="token punctuation">}</span>

<span class="token class-name">User</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setId</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">=</span> id
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>
<span class="token class-name">User</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setName</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> name
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setId</span><span class="token punctuation">(</span><span class="token number">1314</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setName</span><span class="token punctuation">(</span><span class="token string">"sven"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>或者：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token maybe-class-name">User</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
  <span class="token function-variable function">setId</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">=</span> id
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">setName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> name
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token maybe-class-name">User</span><span class="token punctuation">.</span><span class="token method function property-access">setId</span><span class="token punctuation">(</span><span class="token number">1314</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setName</span><span class="token punctuation">(</span><span class="token string">"sven"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>使用链式调用的方式并不会造成太多阅读上的困难，也确实能省下一些字符和中间变量，但节省下来的字符数量同样是微不足道的。链式调用带来的坏处就是在调试的时候非常不方便，如果我们知道一条链中有错误出现，必须得先把这条链拆开才能加上一些调试 log 或者增加断点， 这样才能定位错误出现的地方。
如果该链条的结构相对稳定，后期不易发生修改，那么使用链式调用无可厚非。但如果该链条很容易发生变化，导致调试和维护困难，那么还是建议使用普通调用的形式：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

user<span class="token punctuation">.</span><span class="token method function property-access">setId</span><span class="token punctuation">(</span><span class="token number">1314</span><span class="token punctuation">)</span>
user<span class="token punctuation">.</span><span class="token method function property-access">setName</span><span class="token punctuation">(</span><span class="token string">"sven"</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="%E5%88%86%E8%A7%A3%E5%A4%A7%E5%9E%8B%E7%B1%BB">分解大型类<a class="anchor" href="#%E5%88%86%E8%A7%A3%E5%A4%A7%E5%9E%8B%E7%B1%BB">§</a></h2>
<p>在我编写的 HTML5 版“街头霸王”的第一版代码中，负责创建游戏人物的 Spirit 类非常庞大，不仅要负责创建人物精灵，还包括了人物的攻击、防御等动作方法，代码如下：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function"><span class="token maybe-class-name">Spirit</span></span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> name
<span class="token punctuation">}</span>
<span class="token class-name">Spirit</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">attack</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 攻 击</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"waveBoxing"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">+</span> <span class="token string">": 使用波动拳"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">"whirlKick"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">+</span> <span class="token string">": 使用旋风腿"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> spirit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spirit</span><span class="token punctuation">(</span><span class="token string">"RYU"</span><span class="token punctuation">)</span>
spirit<span class="token punctuation">.</span><span class="token method function property-access">attack</span><span class="token punctuation">(</span><span class="token string">"waveBoxing"</span><span class="token punctuation">)</span> <span class="token comment">// 输出：RYU: 使用波动拳</span>
spirit<span class="token punctuation">.</span><span class="token method function property-access">attack</span><span class="token punctuation">(</span><span class="token string">"whirlKick"</span><span class="token punctuation">)</span> <span class="token comment">// 输出：RYU: 使用旋风腿</span>
</code></pre>
<p>后来发现，Spirit.prototype.attack 这个方法实现是太庞大了，实际上它完全有必要作为一个单独的类存在。面向对象设计鼓励将行为分布在合理数量的更小对象之中：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function"><span class="token maybe-class-name">Attack</span></span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">spirit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">spirit</span> <span class="token operator">=</span> spirit
<span class="token punctuation">}</span>

<span class="token class-name">Attack</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">start</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">list</span><span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token class-name">Attack</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">list</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">waveBoxing</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">spirit</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">+</span> <span class="token string">": 使用波动拳"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">whirlKick</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">spirit</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">+</span> <span class="token string">": 使用旋风腿"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>现在的 Spirit 类变得精简了很多，不再包括各种各样的攻击方法，而是把攻击动作委托给
Attack 类的对象来执行，这段代码也是策略模式的运用之一：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function"><span class="token maybe-class-name">Spirit</span></span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> name
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">attackObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Attack</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token class-name">Spirit</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">attack</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 攻 击</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">attackObj</span><span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> spirit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spirit</span><span class="token punctuation">(</span><span class="token string">"RYU"</span><span class="token punctuation">)</span>
spirit<span class="token punctuation">.</span><span class="token method function property-access">attack</span><span class="token punctuation">(</span><span class="token string">"waveBoxing"</span><span class="token punctuation">)</span> <span class="token comment">// 输出：RYU: 使用波动拳</span>
spirit<span class="token punctuation">.</span><span class="token method function property-access">attack</span><span class="token punctuation">(</span><span class="token string">"whirlKick"</span><span class="token punctuation">)</span> <span class="token comment">// 输出：RYU: 使用旋风腿</span>
</code></pre>
<h2 id="%E7%94%A8-return-%E9%80%80%E5%87%BA%E5%A4%9A%E9%87%8D%E5%BE%AA%E7%8E%AF">用 return 退出多重循环<a class="anchor" href="#%E7%94%A8-return-%E9%80%80%E5%87%BA%E5%A4%9A%E9%87%8D%E5%BE%AA%E7%8E%AF">§</a></h2>
<p>假设在函数体内有一个两重循环语句，我们需要在内层循环中判断，当达到某个临界条件时退出外层的循环。我们大多数时候会引入一个控制标记变量：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> flag <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> j <span class="token operator">></span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword control-flow">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>flag <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">break</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>第二种做法是设置循环标记：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  outerloop<span class="token operator">:</span> <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    innerloop<span class="token operator">:</span> <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> j <span class="token operator">></span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">break</span> outerloop
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这两种做法无疑都让人头晕目眩，更简单的做法是在需要中止循环的时候直接退出整个方法：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> j <span class="token operator">></span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当然用 return 直接退出方法会带来一个问题，如果在循环之后还有一些将被执行的代码呢？ 如果我们提前退出了整个方法，这些代码就得不到被执行的机会：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> j <span class="token operator">></span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// 这句代码没有机会被执行</span>
<span class="token punctuation">}</span>
</code></pre>
<p>为了解决这个问题，我们可以把循环后面的代码放到 return 后面，如果代码比较多，就应该把它们提炼成一个单独的函数：</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> j <span class="token operator">></span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUxODI3Mjc5MQ==&amp;mid=2247484258&amp;idx=1&amp;sn=2b9e72b5caf59126078c8b100a384cbc&amp;chksm=f98a211acefda80cde6bda59bdd10f4d3c1047b6a0ac06902fa3df0dd4cd6ace917fc09dcce1&amp;scene=21#wechat_redirect">待写</a></p></article><div class="prev_next"><a class="prev button" href="/start/Performance.html">«  <!-- -->性能优化</a><a class="next button" href="/start/Mobx.html">Mobx<!-- -->  »</a></div><div id="gitalk-container"></div><link id="gitalk-css" rel="preload" href="https://cdn.pagic.org/gitalk@1.6.2/dist/gitalk.css" as="style"/><script defer="" src="https://cdn.pagic.org/gitalk@1.6.2/dist/gitalk.min.js"></script></div><aside class="main_toc_container nav_link_container"><div class="main_toc"><div class="toc_ad"><div>
        <script data-ad-client="ca-pub-5052023368276507" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- 192*128 -->
<ins
  class="adsbygoogle"
  style="display:inline-block;width:192px;height:128px"
  data-ad-client="ca-pub-5052023368276507"
></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script></div></div><nav class="toc"><ol><li><a href="#%E4%BB%A3%E7%A0%81%E9%87%8D%E6%9E%84%E7%BB%8F%E9%AA%8C">代码重构经验</a><ol><li><a href="#%E6%8F%90%E7%82%BC%E5%87%BD%E6%95%B0">提炼函数</a></li><li><a href="#%E5%90%88%E5%B9%B6%E9%87%8D%E5%A4%8D%E7%9A%84%E6%9D%A1%E4%BB%B6%E7%89%87%E6%AE%B5">合并重复的条件片段</a></li><li><a href="#%E6%8A%8A%E6%9D%A1%E4%BB%B6%E5%88%86%E6%94%AF%E8%AF%AD%E5%8F%A5%E6%8F%90%E7%82%BC%E6%88%90%E5%87%BD%E6%95%B0">把条件分支语句提炼成函数</a></li><li><a href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E5%BE%AA%E7%8E%AF">合理使用循环</a></li><li><a href="#%E6%8F%90%E5%89%8D%E8%AE%A9%E5%87%BD%E6%95%B0%E9%80%80%E5%87%BA%E4%BB%A3%E6%9B%BF%E5%B5%8C%E5%A5%97%E6%9D%A1">提前让函数退出代替嵌套条</a></li><li><a href="#%E4%BC%A0%E9%80%92%E5%AF%B9%E8%B1%A1%E5%8F%82%E6%95%B0%E4%BB%A3%E6%9B%BF%E8%BF%87%E9%95%BF%E7%9A%84%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8">传递对象参数代替过长的参数列表</a></li><li><a href="#%E5%B0%BD%E9%87%8F%E5%87%8F%E5%B0%91%E5%8F%82%E6%95%B0%E6%95%B0%E9%87%8F">尽量减少参数数量</a></li><li><a href="#%E5%B0%91%E7%94%A8%E4%B8%89%E7%9B%AE%E8%BF%90%E7%AE%97%E7%AC%A6">少用三目运算符</a></li><li><a href="#%E5%90%88%E7%90%86%E4%BD%BF%E7%94%A8%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8">合理使用链式调用</a></li><li><a href="#%E5%88%86%E8%A7%A3%E5%A4%A7%E5%9E%8B%E7%B1%BB">分解大型类</a></li><li><a href="#%E7%94%A8-return-%E9%80%80%E5%87%BA%E5%A4%9A%E9%87%8D%E5%BE%AA%E7%8E%AF">用 return 退出多重循环</a></li></ol></li></ol></nav></div></aside></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><div class="tools flex_center hide_on_mobile"><a class="czs-pen button" href="https://github.com/ViktorWong/my-docs/edit/master/docs/start/Codeing.md" target="_blank" style="background-image:url(&quot;/assets/czs-pen.svg&quot;)"></a><a class="czs-angle-up-l button" href="#" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></a></div><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>